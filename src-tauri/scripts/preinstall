#!/bin/bash
set -euo pipefail

# =========================================================================
# SMART DESKTOP MANAGER - NATIVE INSTALLER LOGGING (Preinstall)
# =========================================================================

# 1. Setup Logging
LOG_FILE="/tmp/sdm_installer_$(date +%s).log"
exec > >(tee -a "$LOG_FILE") 2>&1
set -x

echo "========================================================================"
echo "SMART DESKTOP MANAGER INSTALLATION STARTED"
echo "Log File: $LOG_FILE"
echo "========================================================================"

# 1.5. Launch Live Progress Window via AppleScript
echo "Launching live progress viewer..."
osascript -e "
tell application \"Terminal\"
    activate
    do script \"clear && echo '=====================================' && echo 'ðŸ¤– Smart Desktop Manager Setup' && echo '=====================================' && echo 'Setting up your private AI models securely...' && echo 'This window will close automatically once finished.' && echo '' && tail -f $LOG_FILE\"
    set customWindow to front window
    set custom bounds of customWindow to {100, 100, 800, 600}
    set background color of customWindow to {4000, 4000, 4000}
    set cursor color of customWindow to {0, 65535, 0}
    set normal text color of customWindow to {0, 65535, 0}
end tell" || true

# 2. Environment Audit
echo "STEP 1: Environment Audit"
echo "User: $(whoami)"
echo "Date: $(date)"
echo "OS Version: $(sw_vers -productVersion)"
CPU_CORES=$(sysctl -n hw.ncpu)
MEM_GB=$(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 ))
echo "CPU Cores: $CPU_CORES"
echo "RAM: $MEM_GB GB"

# 3. Ollama Installation
echo "STEP 2: Ollama Check"

export PATH="$PATH:/usr/local/bin:/opt/homebrew/bin:/Applications/ollama.app/Contents/MacOS"
OLLAMA_BIN="$(command -v ollama || true)"

if [[ -x "$OLLAMA_BIN" ]]; then
    echo "âœ… Ollama found at: $OLLAMA_BIN"
else
    echo "â¬‡ï¸ Ollama NOT found. Installing..."
    TMP_SCRIPT=$(mktemp /tmp/ollama_install.XXXX.sh)
    curl -fsSL https://ollama.com/install.sh -o "$TMP_SCRIPT"
    chmod +x "$TMP_SCRIPT"
    bash "$TMP_SCRIPT"
    rm -f "$TMP_SCRIPT"
    OLLAMA_BIN="$(command -v ollama || true)"
    if [[ -x "$OLLAMA_BIN" ]]; then
        echo "âœ… Ollama installed successfully"
    else
        echo "âš ï¸ Ollama install failed, continuing..."
    fi
fi

# 3b. ffmpeg (video thumbnails in grid)
echo "STEP 2b: ffmpeg (video thumbnails)"

export PATH="$PATH:/usr/local/bin:/opt/homebrew/bin"
FFMPEG_BIN="$(command -v ffmpeg || true)"

if [[ -x "$FFMPEG_BIN" ]]; then
    echo "âœ… ffmpeg found at: $FFMPEG_BIN"
else
    echo "â¬‡ï¸ ffmpeg NOT found. Installing via Homebrew..."
    if command -v brew >/dev/null 2>&1; then
        if brew install ffmpeg; then
            echo "âœ… ffmpeg installed successfully"
        else
            echo "âš ï¸ ffmpeg install failed, continuing..."
        fi
    else
        echo "âš ï¸ Homebrew not found â€” install manually: brew install ffmpeg"
    fi
fi

# 4. Model Bootstrapping
echo "STEP 3: AI Model Bootstrapping"

REQUIRED_MODELS=("gemma3:1b" "llama3.2:3b")

for MODEL in "${REQUIRED_MODELS[@]}"; do
    echo "--------------------------------------"
    if "$OLLAMA_BIN" list 2>/dev/null | grep -q "$MODEL"; then
        echo "âœ… Required model '$MODEL' already installed."
    else
        echo "â¬‡ï¸ Pulling required model '$MODEL'..."
        if "$OLLAMA_BIN" pull "$MODEL"; then
            echo "âœ… '$MODEL' installed."
        else
            echo "âš ï¸ Failed to pull '$MODEL'. Continuing."
        fi
    fi
done

# 5. Whisper Transcription via whisper.cpp
# echo "STEP 4: Optional Transcription Setup (whisper.cpp)"

# WHISPER_CPP_BIN="/usr/local/bin/whisper.cpp"

# if command -v whisper.cpp >/dev/null 2>&1 || [[ -f "$WHISPER_CPP_BIN" ]]; then
#     echo "âœ… whisper.cpp already available"
# else
#     echo "â¬‡ï¸ Installing whisper.cpp transcription tool"

#     TMP_DIR=$(mktemp -d /tmp/whispercpp.XXXX)
#     git clone https://github.com/ggerganov/whisper.cpp "$TMP_DIR"
#     cd "$TMP_DIR"
#     make

#     if [[ -f ./main ]]; then
#         mv ./main /usr/local/bin/whisper.cpp
#         echo "âœ… whisper.cpp installed"
#     else
#         echo "âš ï¸ whisper.cpp build failed â€” continuing without it"
#     fi

#     cd -
#     rm -rf "$TMP_DIR"
# fi

# 6. Finalization
echo "STEP 5: Finalizing Installation"

READY_DIR="/Library/Application Support/SmartDesktopManager"
mkdir -p "$READY_DIR"
echo "1" > "$READY_DIR/ready"
chmod 755 "$READY_DIR"

echo "========================================================================"
echo "âœ… SUCCESS! Installation Complete"
echo "========================================================================"

# Terminate the tail tracking window that we spooled up
echo "Closing progress viewer..."
osascript -e "
tell application \"Terminal\"
    set windowList to windows
    repeat with aWindow in windowList
        if (name of aWindow) contains \"tail -f\" then
            close aWindow
        end if
    end repeat
end tell" || true

exit 0
